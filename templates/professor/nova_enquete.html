{% extends "index.html" %}

{% block pagetitle %}Nova Enquete{% endblock %}

{% block content %}
  <div class="container py-5">
    {% include '_flashes.html' %}
    
    <div class="d-flex w-100 justify-content-between align-items-center">
      <h2><strong>Nova Enquete</strong></h2>
    </div>

    <div class="mt-4">
      <form action="/professor/enquetes" id="form-enquete" method="post" onsubmit="return validarFormulario()">
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label for="titulo">Nome da enquete</label>
              <input type="text" class="form-control mt-2" id="titulo" name="titulo">
            </div>
          </div>

          <div class="col-md-2">
            <div class="form-group">
              <label for="prazo">Prazo para responder</label>
              <input type="date" class="form-control mt-2" id="prazo" name="prazo">
            </div>
          </div>
        </div>
        
        <div class="pt-4">
          <label>Selecione as perguntas que deseja incluir na enquete:</label>
  
          <div class="bg-light p-3 mt-3">
            <h6><strong class="text-primary"><span role="counting">0/10</span> PERGUNTAS SELECIONADAS</strong></h6>

            <div class="pt-2">
              {% for key, pergunta in perguntas.items() %}
                <div class="mb-1 form-check">
                  <input type="checkbox" class="form-check-input" id="pergunta-{{ key }}" value="{{ key }}" name="perguntas[]">
                  <label class="form-check-label" for="pergunta-{{ key }}">{{ pergunta }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="alert alert-danger mt-4" id="erro-titulo" style="display: none;">
          Preencha o nome da enquete.
        </div>

        <div class="alert alert-danger mt-4" id="erro-prazo" style="display: none;">
          Defina um prazo válido (a partir de hoje).
        </div>

        <div class="alert alert-danger mt-4" id="erro-selecao" style="display: none;">
          Selecione no mínimo 5 perguntas.
        </div>

        <div class="pt-4 d-flex justify-content-end">
          <a href="{{ url_for('professor_enquetes') }}" class="btn btn-secondary">Cancelar</a>&emsp;
          <button type="submit" class="btn btn-success">Criar Enquete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function atualizarContagem() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const countingSpan = document.querySelector('[role="counting"]');
  
      const selecionados = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;
      const total = checkboxes.length;
      countingSpan.textContent = `${selecionados}/${total}`;
  
      if (selecionados >= 5) {
        document.getElementById('erro-selecao').style.display = 'none';
      }
    }
  
    function validarFormulario() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const selecionados = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;
      const titulo = document.getElementById('titulo').value.trim();
      const prazo = document.getElementById('prazo').value; // Captura o valor do prazo
      const hoje = new Date().toISOString().split('T')[0]; // Obtém a data de hoje no formato YYYY-MM-DD
  
      // Divs de erro
      const erroSelecaoDiv = document.getElementById('erro-selecao');
      const erroTituloDiv = document.getElementById('erro-titulo');
      const erroPrazoDiv = document.getElementById('erro-prazo');
  
      // Verifica se o título foi preenchido
      if (titulo === '') {
        erroTituloDiv.style.display = 'block';
        erroSelecaoDiv.style.display = 'none';
        erroPrazoDiv.style.display = 'none';
        return false;
      }
  
      // Verifica se pelo menos 5 perguntas foram selecionadas
      if (selecionados < 5) {
        erroSelecaoDiv.style.display = 'block';
        erroTituloDiv.style.display = 'none';
        erroPrazoDiv.style.display = 'none';
        return false;
      }
  
      // Valida o prazo (não pode estar vazio e deve ser maior ou igual a hoje)
      if (!prazo || prazo < hoje) {
        erroPrazoDiv.style.display = 'block';
        erroTituloDiv.style.display = 'none';
        erroSelecaoDiv.style.display = 'none';
        return false;
      }
  
      // Se tudo estiver correto, permite o envio do formulário
      erroSelecaoDiv.style.display = 'none';
      erroTituloDiv.style.display = 'none';
      erroPrazoDiv.style.display = 'none';
      return true;
    }
  
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', atualizarContagem);
    });
  
    document.getElementById('titulo').addEventListener('input', function () {
      if (this.value.trim() !== '') {
        document.getElementById('erro-titulo').style.display = 'none';
      }
    });
  
    document.getElementById('prazo').addEventListener('change', function () {
      const hoje = new Date().toISOString().split('T')[0];
      if (this.value >= hoje) {
        document.getElementById('erro-prazo').style.display = 'none';
      }
    });
  
    atualizarContagem();
  </script>
{% endblock %}
